= AWS Secrets Manager
:last_updated: 11/23/2021
:linkattrs:

With AWS Secrets Manager you can store your Redshift password in your own hosted AWS Secrets Manager, so ThoughtSpot can fetch it when needed.
This eliminates the need for you to enter the password when you create a new Redshift connection.

== Prerequisites

- Hosted AWS Secrets Manager solution
- ThoughtSpot cluster deployed on Amazon EC2 instance

== Configuring AWS Secrets manager

[#create-aws-kms]
=== Creating and storing the AWS KMS

1. Sign in to the AWS Management Console and open the https://console.aws.amazon.com/kms[AWS Key Management Service (AWS KMS) console^].
2. In the navigation pane, click **Customer-managed keys**, and then click **Create key**.
+
image::create-store-kms-step2.png[]

3. To create a symmetric KMS key, for Key type choose **Symmetric**, and then click **Next**.
+
image::create-store-kms-step3.png[]

4. On the Add labels page, create an alias for the KMS key.
+
image::create-store-kms-step4.png[]

5. Click **Next**.

6. Select the IAM users and roles that can administer the KMS key.
+
image::create-store-kms-step6.png[]

7. Click **Next**.

8. Select the IAM users and roles that can use the KMS key for cryptographic operations.

9. Click **Next**.

10. Review the key settings that you chose. You can still go back and change all settings.

11. Click **Finish** to create the KMS key.

[#create-store-secret]
=== Creating and storing the secret

1. Sign in to the https://console.aws.amazon.com/secretsmanager/[AWS Management Console^].

2. On the Secrets list page click on Store a new secret.
+
image::create-store-sec-step2.png[]

3. On the Store a new secret page, select Other type of secrets. (This type allows you to store key value pairs or plain text.) You can then specify the secrets as key value pairs on this page.
+
image::create-store-sec-step3.png[]

4. For Select the encryption key, choose the AWS KMS key created above in the xref:create-aws-kms[Creating and storing the AWS KMS] section.

5. Click **Next**.

6. Under Secret name, type a name for the secret. It can be only alphanumeric and /_+=.@-.
+
image::image-filename.ext[]

7. Click **Next**.

8. Under configure rotation, select a type which enables AWS Secrets Manager to rotate the secret automatically.
+
image::image-filename.ext[]

9. Click **Next**.

10. Review the final details. Click on Store. This creates a secret.

[#create-store-iam-policy]
=== Creating and storing the IAM Policy

1. Sign in to the AWS Management Console and open the https://console.aws.amazon.com/iam/[AWS IAM console^].

2. In the navigation column on the left, choose **Policies**.
+
image::image-filename.ext[]

3. At the top of the page, click **Create policy**.
+
image::image-filename.ext[]

4. Click the **JSON** tab. Enter the JSON policy using the following format.
+
Example:
+
[source,JSON]
----
{
  "Version": "2012-10-17",
  "Statement": [
	{
  	"Effect": "Allow",
  	"Action": [
    	"secretsmanager:GetResourcePolicy",
    	"secretsmanager:GetSecretValue",
    	"secretsmanager:DescribeSecret",
    	"secretsmanager:ListSecretVersionIds"
  	],
  	"Resource": [
  "arn:aws:secretsmanager:us-west-2:111122223333:secret:aes128-1a2b3c"
  	]
	},
	{
  	"Effect": "Allow",
  	"Action": "secretsmanager:ListSecrets",
  	"Resource": "*"
	},
    	{
        	"Sid": "AllowKMS",
        	"Effect": "Allow",
        	"Action": [
            	"kms:Decrypt",
            	"kms:DescribeKey"
        	],
        	"Resource": [
            "arn:aws:kms:us-west-2:111122223333:key/mrk-5e2384a66c563d33b9a595de4702536"
        	]
    	}
  ]
}
----
+
NOTE: Resource should have Secret ARN for which the policy is defined, and the KMS used for it.

5. Click on **Next: Tags**, and then **Next: Review**.

6. On the Review policy page, enter a Name and an optional Description for the policy that you are creating. Review the policy summary to see the permissions that are granted by your policy. Then click **Create policy** to save.
+
image::image-filename.ext[]

[#create-store-iam-role]
=== Creating and storing the IAM Role

1. Sign in to the AWS Management Console and open the https://console.aws.amazon.com/iam/[AWS IAM console^].

2. In the navigation column on the left, click **Roles**, and then **Create role**.
+
image::image-filename.ext[]

3. Choose the AWS service role type, and then choose the service that you want to allow to assume this role. For AWS secret manager choose **EC2**, then click **Next:Permissions**.
+
image::image-filename.ext[]

4. Select the policy created above in the xref:create-store-iam-policy[Creating and storing the IAM policy] section, and the click **Next: Tags**.
+
image::image-filename.ext[]

5. Click **Next: Review**.

6. Enter a Name and an optional Description for the role that you are creating.
+
image::image-filename.ext[]

7. Review the role and then click **Create role**.

[#attach-iam-role-instance]
=== Attach an IAM role to an instance

1. Open the https://console.aws.amazon.com/ec2/[Amazon EC2 console^].

2. In the navigation pane, select the instance, choose Actions, Security, Modify IAM role.
+
image::image-filename.ext[]

3. Select the IAM role to attach to your instance, and then click **Save**.

=== Access secrets across AWS accounts

1. Consider we have two different AWS accounts i.e. PRODUCTION account (the account where you run applications) and CENTRAL_SECURITY account (the account where you manage secrets).

2. On the CENTRAL_SECURITY account:
.. Create a AWS key as described in the xref:create-aws-kms[Creating and storing the AWS KMS] section.
.. Create an AWS secret as mentioned in the xref:create-store-secret[Creating and storing the secret] section.
.. Create an IAM role with a policy which allows permissions for secrets and a KMS decryption used for the secrets as described in the xref:create-store-iam-policy[Creating and storing the IAM Policy] and the xref:create-store-iam-role[Creating and storing the IAM Role] sections.
.. Also under the trust relationships in IAM role, add the PRODUCTION account IAM role details to assume it. Like below which is just for a reference.
+
Example:
+
[source,JSON]
----
{
  "Version": "2012-10-17",
  "Statement": [
	{
  	"Effect": "Allow",
  	"Principal": {
    	"Service": "ec2.amazonaws.com"
  	},
  	"Action": "sts:AssumeRole"
	},
	{
  	"Sid": "VisualEditor3",
  	"Effect": "Allow",
  	"Principal": {
    	"AWS": "arn:aws:iam::982380164364:role/production_role"
  	},
  	"Action": "sts:AssumeRole"
	}
  ]
----

3. On the PRODUCTION account create an IAM role with a policy which assumes the CENTRAL_SECURITY account IAM role where secrets are defined. The following example is provided just for reference.
+
Example:
+
[source,JSON]
----
{
	"Version": "2012-10-17",
	"Statement": [
    	{
        	"Sid": "VisualEditor0",
        	"Effect": "Allow",
        	"Action": "sts:AssumeRole",
        	"Resource": [
            	"arn:aws:iam::111122223333:role/central_security_role"
        	]
    	}
	]
}
----

4. Attach the PRODUCTION account IAM role to EC2 instance. Follow the steps the xref:attach-iam-role-instance[Attach an IAM role to an instance].

== Next steps

In order for ThoughtSpot to contact AWS Secrets Manager, some configuration fields need to be added whenever a new Redshift connection is created.

'''
> **Related information**
>
> * xref:connections-redshift-add.adoc[Create a Redshift connection]
> * https://aws.amazon.com/secrets-manager/[AWS Secrets Manager^]
> * xref:aws-configuration-options.adoc[AWS configuration options]
